@page "/readers"
@using Blazorise
@inject LibraryApiWrapper LibraryApi
@inject IJSRuntime JsRuntime

<h3>Список читателей</h3>

<Modal @ref="validationModalRef">
    <ModalContent>
        <ModalHeader>
            <ModalTitle>
                <Icon Name="IconName.ExclamationTriangle" Color="Color.Danger" Class="me-2" />
                Ошибка заполнения формы
            </ModalTitle>
            <CloseButton @onclick="CloseValidationModal" />
        </ModalHeader>
        <ModalBody>
            <Alert Color="Color.Danger" Icon="IconName.InfoCircle">@errorMessage</Alert>
            <div class="mt-2">
                <p>Пожалуйста, заполните все поля, отмеченные звездочкой (*).</p>
            </div>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" @onclick="CloseValidationModal">Закрыть</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

<Button Color="Color.Success" Class="mb-3" @onclick="StartCreate">+ Добавить читателя</Button>

@if (selectedReader != null)
{
    <Card Class="mb-4">
        <CardBody>
            <h5>@(selectedReader.Id == 0 ? "Добавить читателя" : $"Редактировать: {selectedReader.FullName}")</h5>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <Alert Color="Color.Danger" Class="mt-2">@errorMessage</Alert>
            }

            <Field>
                <FieldLabel>Полное имя *</FieldLabel>
                <TextEdit @bind-Text="formReader.FullName" />
            </Field>

            <Field>
                <FieldLabel>Адрес</FieldLabel>
                <TextEdit @bind-Text="formReader.Address" />
            </Field>

            <Field>
                <FieldLabel>Телефон</FieldLabel>
                <TextEdit @bind-Text="formReader.Phone" />
            </Field>

            <Field>
                <FieldLabel>Дата регистрации *</FieldLabel>
                <DateEdit @bind-Date="formReader.RegistrationDate"
                          Max="DateTime.Today" />
            </Field>

            <div class="mt-3">
                <Button Color="Color.Primary" @onclick="SaveAsync">Сохранить</Button>
                <Button Color="Color.Secondary" @onclick="CancelForm">Отмена</Button>
            </div>
        </CardBody>
    </Card>
}

@if (isLoading)
{
    <p>Загрузка...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <Alert Color="Color.Danger">@errorMessage</Alert>
}
else if (readers.Count == 0)
{
    <Alert Color="Color.Warning">Читатели не найдены</Alert>
}
else
{
    <Table Striped Hover>
        <TableHeader>
            <TableRow>
                <TableHeaderCell>ФИО</TableHeaderCell>
                <TableHeaderCell>Адрес</TableHeaderCell>
                <TableHeaderCell>Телефон</TableHeaderCell>
                <TableHeaderCell>Дата регистрации</TableHeaderCell>
                <TableHeaderCell>Действия</TableHeaderCell>
            </TableRow>
        </TableHeader>
        <TableBody>
            @foreach (var reader in readers)
            {
                <TableRow>
                    <td>@reader.FullName</td>
                    <td>@reader.Address</td>
                    <td>@reader.Phone</td>
                    <td>@reader.RegistrationDate.ToString("dd.MM.yyyy")</td>
                    <td>
                        <Buttons>
                            <Button Color="Color.Info" Size="Size.Small" @onclick="() => StartEdit(reader)">Редактировать</Button>
                            <Button Color="Color.Danger" Size="Size.Small" @onclick="() => DeleteReaderAsync(reader.Id)">Удалить</Button>
                        </Buttons>
                    </td>
                </TableRow>
            }
        </TableBody>
    </Table>
}

@code {
    private List<BookReaderGetDto> readers = new();
    private bool isLoading;
    private string errorMessage = "";
    private BookReaderGetDto? selectedReader = null;
    private BookReaderCreateDto formReader=new();
    private Modal? validationModalRef;

    protected override async Task OnInitializedAsync() => await LoadAllDataAsync();

    private async Task LoadAllDataAsync()
    {
        try
        {
            isLoading = true;
            readers = (await LibraryApi.GetAllReaders())?.ToList() ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка загрузки: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void StartCreate()
    {
        selectedReader = new();
        formReader.RegistrationDate = DateTime.Today;
    }

    private void StartEdit(BookReaderGetDto reader)
    {
        selectedReader = reader;
        formReader.FullName = reader.FullName;
        formReader.Address = reader.Address;
        formReader.Phone = reader.Phone;
        formReader.RegistrationDate = reader.RegistrationDate;
    }

    private void CancelForm()
    {
        selectedReader = null;
        formReader = new();

    }

    private bool IsFormValid() => !string.IsNullOrWhiteSpace(formReader.FullName);

    private async Task SaveAsync()
    {
        errorMessage = "";

        if (!IsFormValid())
        {
            errorMessage = "Пожалуйста, заполните все обязательные поля";
            validationModalRef?.Show();
            return;
        }

        try
        {
            if (selectedReader?.Id == 0)
                await LibraryApi.CreateReader(formReader);
            else if (selectedReader != null)
                await LibraryApi.UpdateReader(selectedReader.Id, formReader);

            await LoadAllDataAsync();
            CancelForm();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка сохранения: {ex.Message}";
        }
    }

    private void CloseValidationModal() => validationModalRef?.Hide();

    private async Task DeleteReaderAsync(int id)
    {
        await LibraryApi.DeleteReader(id);
        await LoadAllDataAsync();
    }
}
