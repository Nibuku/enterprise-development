@page "/"
@inject LibraryApiWrapper LibraryApi

<h3>Аналитика библиотеки</h3>

@if (!string.IsNullOrEmpty(error))
{
    <Alert Color="Color.Danger">@error</Alert>
}
<div class="d-flex gap-4 mb-2">
<Field>
    <FieldLabel>Начальная дата</FieldLabel>
    <DateEdit @bind-Date="startDate" />
</Field>

<Field>
    <FieldLabel>Конечная дата</FieldLabel>
    <DateEdit @bind-Date="endDate" />
</Field>
</div>
<Buttons Class="d-flex flex-wrap gap-1 mt-3 mb-3">
    <Button Color="Color.Primary" @onclick="LoadIssuedBooks">
        <div>Выданные книги</div>
    </Button>
    <Button Color="Color.Primary" @onclick="LoadTopReadersByCount">
        <div>ТОП читателей (по кол-во книг)</div>
        <small class="text-light">Укажите период</small>
    </Button>
    <Button Color="Color.Primary" @onclick="LoadTopReadersByDays">ТОП читателей (дни)</Button>
    <Button Color="Color.Primary" @onclick="LoadTopPublishers">ТОП издательств</Button>
    <Button Color="Color.Primary" @onclick="LoadLeastPopularBooks">Непопулярные книги</Button>
</Buttons>

@if (isLoading)
{
    <p>Загрузка...</p>
}

@if (issuedBooks.Any())
{
    <h5>Выданные книги</h5>
    <Table Striped Hover>
        <thead>
            <tr><th>Книга</th><th>Количество</th></tr>
        </thead>
        <tbody>
            @foreach (var b in issuedBooks)
            {
                <tr><td>@b.Title</td><td>@b.Count</td></tr>
            }
        </tbody>
    </Table>
}

@if (topReadersByCount.Any())
{
    <h5>ТОП читателей по количеству</h5>
    <Table Striped Hover>
        <thead>
            <tr><th>Читатель</th><th>Книг</th></tr>
        </thead>
        <tbody>
            @foreach (var r in topReadersByCount)
            {
                <tr><td>@r.FullName</td><td>@r.Count</td></tr>
            }
        </tbody>
    </Table>
}

@if (topReadersByDays.Any())
{
    <h5>ТОП читателей по дням</h5>
    <Table Striped Hover>
        <thead>
            <tr><th>Читатель</th><th>Дней</th></tr>
        </thead>
        <tbody>
            @foreach (var r in topReadersByDays)
            {
                <tr><td>@r.FullName</td><td>@r.TotalDays</td></tr>
            }
        </tbody>
    </Table>
}

@if (topPublishers.Any())
{
    <h5>ТОП издательств</h5>
    <Table Striped Hover>
        <thead>
            <tr><th>Издательство</th><th>Книг</th></tr>
        </thead>
        <tbody>
            @foreach (var p in topPublishers)
            {
                <tr><td>@p.Name</td><td>@p.Count</td></tr>
            }
        </tbody>
    </Table>
}

@if (leastPopularBooks.Any())
{
    <h5>Наименее популярные книги</h5>
    <Table Striped Hover>
        <thead>
            <tr><th>Книга</th><th>Выдач</th></tr>
        </thead>
        <tbody>
            @foreach (var b in leastPopularBooks)
            {
                <tr><td>@b.Title</td><td>@b.Count</td></tr>
            }
        </tbody>
    </Table>
}

@code {
    bool isLoading;
    string error = "";

    DateOnly? startDate;
    DateOnly? endDate;

    List<BookWithCountDto> issuedBooks = new();
    List<BookReaderWithCountDto> topReadersByCount = new();
    List<BookReaderWithDaysDto> topReadersByDays = new();
    List<PublisherCountDto> topPublishers = new();
    List<BookWithCountDto> leastPopularBooks = new();

    DateTimeOffset? ToOffset(DateOnly? d) => d == null ? null : new DateTimeOffset(d.Value.ToDateTime(TimeOnly.MinValue));

    async Task Load(Func<Task> action)
    {
        try
        {
            isLoading = true;
            error = "";
            Clear();
            await action();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    void Clear()
    {
        issuedBooks.Clear();
        topReadersByCount.Clear();
        topReadersByDays.Clear();
        topPublishers.Clear();
        leastPopularBooks.Clear();
    }

    Task LoadIssuedBooks() => Load(async () => issuedBooks = (await LibraryApi.GetIssuedBooks()).ToList());

    Task LoadTopReadersByCount() =>Load(async () => topReadersByCount =
            (await LibraryApi.GetTopReadersByCountAsync(ToOffset(startDate), ToOffset(endDate))).ToList());

    Task LoadTopReadersByDays() =>Load(async () => topReadersByDays =
            (await LibraryApi.GetTopReadersByDays()).ToList());

    Task LoadTopPublishers() =>Load(async () => topPublishers =
            (await LibraryApi.GetTopPublishers(ToOffset(startDate))).ToList());

    Task LoadLeastPopularBooks() =>Load(async () => leastPopularBooks =
            (await LibraryApi.GetLeastPopularBooks(ToOffset(startDate))).ToList());
}
